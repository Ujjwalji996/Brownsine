<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>File Manager v2</title>
<style>
body{background:#fff;color:#000;font-family:Inter,Arial;margin:20px;}
.toolbar{display:flex;gap:12px;align-items:center;margin-bottom:14px;}
.controls{display:flex;gap:8px;align-items:center;}
.file-grid{display:flex;flex-wrap:wrap;gap:12px;}
.file-box{position:relative;width:180px;padding:8px;border:2px solid #ddd;border-radius:8px;cursor:pointer;background:#fff;}
.file-box.selected{border-color:#007bff;background:#e8f0ff;}
.thumb{width:164px;height:120px;object-fit:cover;border-radius:6px;display:block;margin:0 auto;}
.overlay-label{position:absolute;left:8px;top:8px;background:rgba(0,0,0,0.7);color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;}
.info{margin-top:6px;font-size:13px;color:#000;text-align:left;}
.filter-panel{display:flex;gap:8px;align-items:center;background:#fafafa;padding:8px;border-radius:8px;border:1px solid #eee;}
.small{padding:6px 8px;border-radius:6px;border:1px solid #ccc;}
button{background:#000;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>
<body>
<h2>File Manager v2</h2>

<div class="toolbar">
  <form action="/upload" method="post" enctype="multipart/form-data" style="display:inline-block;">
    <input type="file" name="file" multiple required>
    <button type="submit">Upload (multiple)</button>
  </form>

  <div class="controls">
    <button onclick="deleteSelected()">Delete Selected</button>
    <button onclick="clearSelection()">Clear</button>
    <span id="count">Selected: 0</span>
  </div>
</div>

<div class="filter-panel">
  <input id="searchName" class="small" placeholder="Search name...">
  <select id="filterType" class="small">
    <option value="">All types</option>
    <option value="image">Image</option>
    <option value="video">Video</option>
    <option value="html">HTML</option>
    <option value="text">Text</option>
    <option value="doc">Doc/Other</option>
  </select>
  <input id="sizeMin" class="small" placeholder="Min KB" type="number" min="0" style="width:90px;">
  <input id="sizeMax" class="small" placeholder="Max KB" type="number" min="0" style="width:90px;">
  <label>From <input id="dateFrom" type="date" class="small"></label>
  <label>To <input id="dateTo" type="date" class="small"></label>
  <button onclick="applyFilters()">Apply</button>
  <button onclick="resetFilters()">Reset</button>
</div>

<div style="margin-top:12px;" id="grid" class="file-grid">
  {% for f in files %}
  <div class="file-box" data-name="{{f.name}}" data-type="{{f.type}}" data-size="{{f.size}}" data-date="{{f.date}}" data-sub="{{f.subfolder}}" onclick="toggle(this,event)">
    {% if f.type == 'image' %}
      <img class="thumb" src="/storage/{{f.subfolder}}/{{f.name}}" draggable="false">
    {% elif f.type == 'video' %}
      <video class="thumb" src="/storage/{{f.subfolder}}/{{f.name}}" muted></video>
    {% else %}
      <div style="width:164px;height:120px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#f2f2f2;font-size:36px;">ðŸ“„</div>
    {% endif %}
    <div class="overlay-label">{{f.type}}</div>
    <div class="info">
      <div style="font-weight:700;">{{f.name}}</div>
      <div>Size: {{f.size}} KB</div>
      <div>Date: {{f.date}}</div>
      <div style="margin-top:6px;">
        <button onclick="event.stopPropagation(); renamePrompt('{{f.name}}','{{f.subfolder}}')">Rename</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
const selected = new Map();

function updateCount(){ document.getElementById('count').innerText = 'Selected: ' + selected.size; }

function toggle(el, ev){
  const name = el.dataset.name;
  const sub = el.dataset.sub;
  const key = sub + '||' + name;
  if (selected.has(key)){
    selected.delete(key);
    el.classList.remove('selected');
  } else {
    selected.set(key, {name, sub});
    el.classList.add('selected');
  }
  updateCount();
}

function clearSelection(){
  selected.clear();
  document.querySelectorAll('.file-box.selected').forEach(e=>e.classList.remove('selected'));
  updateCount();
}

function deleteSelected(){
  if (selected.size===0){ alert('Select files first'); return; }
  if (!confirm('Delete selected?')) return;
  const arr = Array.from(selected.values());
  fetch('/delete',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({files: arr})})
    .then(r=>r.json()).then(()=> location.reload());
}

function renamePrompt(oldName, sub){
  const newName = prompt('New name (include extension):', oldName);
  if (!newName) return;
  fetch('/rename',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({old_name: oldName, new_name: newName, sub: sub})})
    .then(r=>r.json()).then(()=> location.reload());
}

// Filters
function applyFilters(){
  const name = document.getElementById('searchName').value.toLowerCase();
  const type = document.getElementById('filterType').value;
  const min = parseInt(document.getElementById('sizeMin').value||0,10);
  const max = parseInt(document.getElementById('sizeMax').value||99999999,10);
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;
  document.querySelectorAll('#grid .file-box').forEach(el=>{
    const fname = el.dataset.name.toLowerCase();
    const ftype = el.dataset.type;
    const fsize = parseInt(el.dataset.size,10);
    const fdate = el.dataset.date.split(' ')[0];
    let ok = true;
    if (name && !fname.includes(name)) ok = false;
    if (type && ftype !== type) ok = false;
    if (fsize < min || fsize > max) ok = false;
    if (from && fdate < from) ok = false;
    if (to && fdate > to) ok = false;
    el.style.display = ok ? '' : 'none';
  });
}

function resetFilters(){
  document.getElementById('searchName').value='';
  document.getElementById('filterType').value='';
  document.getElementById('sizeMin').value='';
  document.getElementById('sizeMax').value='';
  document.getElementById('dateFrom').value='';
  document.getElementById('dateTo').value='';
  applyFilters();
}
</script>

</body>
</html>